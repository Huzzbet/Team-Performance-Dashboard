<!-- ===================== -->
<!-- U14 SEASON DASHBOARD -->
<!-- PART 1 OF 3          -->
<!-- ===================== -->

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<title>U14 Season Analytics Dashboard</title>

<style>
/* ============================================================
   DESIGN TOKENS
   ============================================================ */

:root{
  --bg0:#020617;
  --bg1:#071229;
  --card:#0b1932;
  --card2:#0a1630;
  --border:rgba(255,255,255,.10);
  --text:#e8eefc;
  --muted:#9fb0d0;
  --muted2:#7f93ba;

  --accent:#6ee7ff;
  --green:#2bd47d;
  --amber:#ffd166;
  --red:#ff5c7a;
  --purple:#a78bfa;

  --shadow:0 24px 60px rgba(0,0,0,.55);
  --radius:22px;
  --radius2:16px;
  --font: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:var(--font);
  color:var(--text);
  background:
    radial-gradient(1200px 700px at 18% 8%, rgba(110,231,255,.16), transparent 58%),
    radial-gradient(900px 600px at 85% 18%, rgba(167,139,250,.14), transparent 60%),
    radial-gradient(900px 700px at 40% 95%, rgba(43,212,125,.10), transparent 55%),
    linear-gradient(180deg, var(--bg1), var(--bg0));
  min-height:100vh;
}

/* ============================================================
   LAYOUT
   ============================================================ */

.wrap{
  max-width:1180px;
  margin:0 auto;
  padding:28px 18px 60px;
}

.topbar{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:14px;
  margin-bottom:18px;
}

.title{
  display:flex;
  flex-direction:column;
  gap:6px;
}

.title h1{
  margin:0;
  font-size:22px;
  letter-spacing:.2px;
}

.title .sub{
  color:var(--muted);
  font-size:13px;
  line-height:1.35;
}

/* ============================================================
   CONTROLS
   ============================================================ */

.controls{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  justify-content:flex-end;
}

.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.05);
  box-shadow:0 10px 28px rgba(0,0,0,.25) inset;
  color:var(--text);
  font-size:12px;
  user-select:none;
}

.pill strong{font-weight:800}

.dot{
  width:8px;
  height:8px;
  border-radius:999px;
  background:var(--accent);
  box-shadow:0 0 0 4px rgba(110,231,255,.12)
}

.dot.warn{
  background:var(--amber);
  box-shadow:0 0 0 4px rgba(255,209,102,.14)
}

.dot.good{
  background:var(--green);
  box-shadow:0 0 0 4px rgba(43,212,125,.12)
}

.dot.bad{
  background:var(--red);
  box-shadow:0 0 0 4px rgba(255,92,122,.14)
}

.btn{
  appearance:none;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:var(--text);
  padding:10px 12px;
  border-radius:12px;
  font-weight:800;
  font-size:12px;
  cursor:pointer;
  transition:transform .06s ease, background .2s ease, border-color .2s ease;
}

.btn:hover{
  background:rgba(255,255,255,.09);
  border-color:rgba(255,255,255,.20)
}

.btn:active{ transform:translateY(1px) }

.btn.primary{
  border-color:rgba(110,231,255,.35);
  background:rgba(110,231,255,.10);
}

.btn.danger{
  border-color:rgba(255,92,122,.35);
  background:rgba(255,92,122,.10);
}

/* ============================================================
   CARDS
   ============================================================ */

.card{
  border:1px solid rgba(255,255,255,.10);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;
  margin-bottom:14px;
}

.card .hd{
  padding:14px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  border-bottom:1px solid rgba(255,255,255,.08);
  background:linear-gradient(180deg, rgba(255,255,255,.06), transparent);
}

.card .hd h2{
  margin:0;
  font-size:14px;
  letter-spacing:.2px;
}

.card .hd .hint{
  color:var(--muted);
  font-size:12px;
}

.card .bd{
  padding:14px 16px;
}

/* ============================================================
   STAT TILES
   ============================================================ */

.tiles{
  display:grid;
  grid-template-columns: repeat(12, 1fr);
  gap:12px;
}

.tile{
  grid-column: span 3;
  min-height:82px;
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  background:
    radial-gradient(900px 150px at 20% 0%, rgba(110,231,255,.12), transparent 55%),
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  padding:12px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}

.tile .k{
  color:var(--muted);
  font-size:11px;
  letter-spacing:.3px;
  text-transform:uppercase
}

.tile .v{
  font-size:22px;
  font-weight:900;
}

.tile .s{
  color:var(--muted2);
  font-size:12px;
}

@media (max-width: 980px){
  .tile{ grid-column: span 6; }
}

@media (max-width: 540px){
  .tile{ grid-column: span 12; }
}

/* ===================== */
/* END PART <!-- ===================== -->
<!-- U14 SEASON DASHBOARD -->
<!-- PART 2 OF 3          -->
<!-- (append directly after Part 1) -->
<!-- ===================== -->

/* ============================================================
   TABLES
   ============================================================ */

table{
  width:100%;
  border-collapse:collapse;
  overflow:hidden;
  border-radius:14px;
}

thead th{
  text-align:left;
  font-size:11px;
  color:var(--muted);
  font-weight:900;
  letter-spacing:.3px;
  text-transform:uppercase;
  padding:10px 10px;
  border-bottom:1px solid rgba(255,255,255,.08);
}

tbody td{
  padding:10px 10px;
  border-bottom:1px solid rgba(255,255,255,.07);
  font-size:13px;
}

tbody tr:hover{ background:rgba(255,255,255,.04); }

.mono{ font-family:var(--mono); }
.right{ text-align:right; }
.muted{ color:var(--muted); }

.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:5px 10px;
  border-radius:999px;
  font-size:11px;
  font-weight:900;
  letter-spacing:.2px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
}

.b-good{ border-color:rgba(43,212,125,.30); background:rgba(43,212,125,.12); color:#bff6da; }
.b-bad{ border-color:rgba(255,92,122,.30); background:rgba(255,92,122,.12); color:#ffd0da; }
.b-mid{ border-color:rgba(255,209,102,.30); background:rgba(255,209,102,.12); color:#ffe9b4; }

.click{
  cursor:pointer;
  text-decoration:none;
  color:var(--text);
}

.click:hover{ color:var(--accent); }

/* ============================================================
   CHARTS
   ============================================================ */

.chartWrap{
  display:grid;
  grid-template-columns: repeat(12, 1fr);
  gap:12px;
}

.chartCard{
  grid-column: span 6;
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
  padding:12px;
  overflow:hidden;
}

.chartCard h3{
  margin:0 0 8px 0;
  font-size:12px;
  color:var(--muted);
  font-weight:900;
  letter-spacing:.2px;
  text-transform:uppercase;
}

canvas{
  width:100%;
  height:240px;
  border-radius:12px;
  background:rgba(0,0,0,.18);
  border:1px solid rgba(255,255,255,.06);
}

@media (max-width: 980px){
  .chartCard{ grid-column: span 12; }
  canvas{ height:220px; }
}

/* ============================================================
   MODALS
   ============================================================ */

.backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  padding:18px;
  z-index:50;
}

.modal{
  width:min(940px, 100%);
  max-height:86vh;
  overflow:auto;
  border:1px solid rgba(255,255,255,.12);
  border-radius:22px;
  background:linear-gradient(180deg, rgba(10,22,48,.98), rgba(2,6,23,.98));
  box-shadow:0 40px 80px rgba(0,0,0,.65);
}

.modal .mh{
  position:sticky;
  top:0;
  background:linear-gradient(180deg, rgba(10,22,48,.98), rgba(10,22,48,.85));
  padding:14px 16px;
  border-bottom:1px solid rgba(255,255,255,.10);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}

.modal .mh h2{ margin:0; font-size:14px; }
.modal .mb{ padding:14px 16px; }

.closeX{
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  border-radius:12px;
  padding:8px 10px;
  cursor:pointer;
  color:var(--text);
  font-weight:900;
}

/* ============================================================
   EDITOR
   ============================================================ */

.editor{
  display:grid;
  grid-template-columns: 1fr;
  gap:10px;
}

.ta{
  width:100%;
  min-height:220px;
  resize:vertical;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22);
  color:var(--text);
  padding:12px 12px;
  font-family:var(--mono);
  font-size:12px;
  line-height:1.45;
  outline:none;
}

.ta:focus{
  border-color:rgba(110,231,255,.35);
  box-shadow:0 0 0 4px rgba(110,231,255,.10)
}

.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}

.row .pill{ padding:8px 10px }
.spacer{ height:8px }
.small{ font-size:12px; color:var(--muted); line-height:1.4 }
</style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="title">
      <h1>U14 Season Analytics Dashboard</h1>
      <div class="sub">
        Season analytics for <strong>Lakers U14 Boys Copper</strong> (results, player scoring, fouls, trends).<br/>
        Loads from <span class="mono">/data/season-2026.json</span> on GitHub Pages. Includes editor + CSV export.
      </div>
    </div>

    <div class="controls">
      <div class="pill" id="loadedPill">
        <span class="dot warn" id="loadedDot"></span>
        <strong id="loadedCount">0</strong> / 10 games loaded
      </div>
      <button class="btn primary" id="btnOpenEditor">Add / Edit Games</button>
      <button class="btn" id="btnExport">Export CSV</button>
      <!-- FIXED: valid button closing tag -->
      <button class="btn danger" id="btnReset">Reset to Uploaded Data</button>
    </div>
  </div>

  <!-- Snapshot -->
  <div class="card">
    <div class="hd">
      <h2>Season Snapshot</h2>
      <div class="hint">Auto-calculated from loaded games</div>
    </div>
    <div class="bd">
      <div class="tiles" id="tiles"></div>
    </div>
  </div>

  <!-- Charts -->
  <div class="card">
    <div class="hd">
      <h2>Trends</h2>
      <div class="hint">Points for/against and margins over time</div>
    </div>
    <div class="bd">
      <div class="chartWrap">
        <div class="chartCard">
          <h3>Team Points (For vs Against)</h3>
          <canvas id="chartForAgainst" width="800" height="300"></canvas>
        </div>
        <div class="chartCard">
          <h3>Margins</h3>
          <canvas id="chartMargins" width="800" height="300"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Results table -->
  <div class="card">
    <div class="hd">
      <h2>Game Results</h2>
      <div class="hint">Click a game to open detail modal</div>
    </div>
    <div class="bd">
      <table>
        <thead>
          <tr>
            <th style="width:70px;">Game</th>
            <th>Opponent</th>
            <th class="right">Score</th>
            <th class="right">Margin</th>
            <th style="width:130px;">Result</th>
            <th class="right">1H / 2H</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Player leaderboards -->
  <div class="card">
    <div class="hd">
      <h2>Player Analytics</h2>
      <div class="hint">Totals + per-game + splits (1PT/2PT/3PT) + fouls</div>
    </div>
    <div class="bd">
      <table>
        <thead>
          <tr>
            <th>Player</th>
            <th class="right">Games</th>
            <th class="right">PTS</th>
            <th class="right">PPG</th>
            <th class="right">1PT</th>
            <th class="right">2PT</th>
            <th class="right">3PT</th>
            <th class="right">Fouls</th>
            <th class="right">FPG</th>
            <th class="right">High</th>
            <th class="right">Low</th>
            <th class="right">% Team Pts</th>
          </tr>
        </thead>
        <tbody id="playersBody"></tbody>
      </table>
      <div class="spacer"></div>
      <div class="small">
        Tip: If a player’s totals look low, check if they are missing from a game’s player list — add them in the editor and analytics will recalc instantly.
      </div>
    </div>
  </div>
</div>

<!-- Modal (Game Detail) -->
<div class="backdrop" id="backdrop">
  <div class="modal">
    <div class="mh">
      <h2 id="modalTitle">Game Detail</h2>
      <button class="closeX" id="btnClose">Close</button>
    </div>
    <div class="mb" id="modalBody"></div>
  </div>
</div>

<!-- Modal (Editor) -->
<div class="backdrop" id="editorBackdrop">
  <div class="modal">
    <div class="mh">
      <h2>Games Data Editor</h2>
      <div class="row">
        <span class="pill"><span class="dot"></span>Paste / edit the JSON and click <strong>Apply</strong></span>
        <button class="btn primary" id="btnApply">Apply</button>
        <button class="btn" id="btnCancelEditor">Cancel</button>
      </div>
    </div>
    <div class="mb">
      <div class="small">
        This dashboard loads games from <span class="mono">/data/season-2026.json</span>. If you paste here, it edits in-memory (and exports CSV).
        <br/>Format per game (extended):
        <span class="mono">{ "game": 10, "opponent":"...", "team":"Lakers U14 Boys Copper", "oppTeam":"...", "teamScore":26, "oppScore":28, "halves":{"h1":{"team":10,"opp":16},"h2":{"team":16,"opp":12}}, "players":[{"name":"...", "pts":6, "ft":0, "two":3, "three":0, "fouls":2}] }</span>
      </div>
      <div class="spacer"></div>
      <textarea class="ta" id="jsonEditor" spellcheck="false"></textarea>
      <div class="spacer"></div>
      <div class="row">
        <button class="btn" id="btnFillTemplate">Insert Blank Game Template</button>
        <button class="btn danger" id="btnClear">Clear</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ============================================================
   1) FALLBACK RAW DATA (Games 3–9 from earlier screenshots)
   NOTE: Real season data is loaded from /data/season-2026.json
   ============================================================ */

const INITIAL_GAMES = [
  {
    game: 3,
    opponent: "Vampire Wolves U14 Boys",
    team: "Lakers U14 Boys Copper",
    oppTeam: "Vampire Wolves U14 Boys",
    teamScore: 30,
    oppScore: 23,
    halves: { h1:{team:19, opp:7}, h2:{team:11, opp:16} },
    players: [
      { name:"Jacob Nguyen", pts:0, ft:0, two:0, three:0, fouls:0 },
      { name:"Tate Power",   pts:2, ft:0, two:1, three:0, fouls:0 },
      { name:"Ethan Poon",   pts:6, ft:2, two:2, three:0, fouls:1 },
      { name:"Lior Rizvash", pts:3, ft:1, two:1, three:0, fouls:0 },
      { name:"Rodion Prystupa", pts:4, ft:0, two:2, three:0, fouls:2 },
      { name:"Archer Kenny", pts:0, ft:0, two:0, three:0, fouls:0 },
      { name:"Bill Pham", pts:0, ft:0, two:0, three:0, fouls:0 },
      { name:"Thomas O'Sullivan", pts:0, ft:0, two:0, three:0, fouls:0 }
    ],
    note: "From screenshots: totals line shows 30 pts, 7 FT, 10 2PT, 1 3PT, 3 fouls."
  },
  {
    game: 4,
    opponent: "St Kilda Warriors BRAVE U14 Boys",
    team: "Lakers U14 Boys Copper",
    oppTeam: "St Kilda Warriors BRAVE U14 Boys",
    teamScore: 30,
    oppScore: 17,
    halves: { h1:{team:14, opp:5}, h2:{team:16, opp:12} },
    players: [
      { name:"Archer Kenny", pts:5, ft:0, two:1, three:1, fouls:1 },
      { name:"Bill Pham", pts:4, ft:0, two:2, three:0, fouls:4 },
      { name:"Jacob Nguyen", pts:0, ft:0, two:0, three:0, fouls:0 },
      { name:"Tate Power", pts:0, ft:0, two:0, three:0, fouls:1 },
      { name:"Ethan Poon", pts:12, ft:0, two:6, three:0, fouls:2 },
      { name:"Lior Rizvash", pts:4, ft:0, two:2, three:0, fouls:3 },
      { name:"Rodion Prystupa", pts:5, ft:1, two:2, three:0, fouls:5 }
    ],
    note: "Totals line shows 30 pts, 1 FT, 13 2PT, 1 3PT, 16 fouls."
  },
  {
    game: 5,
    opponent: "Vampire Wolves U14 Boys",
    team: "Lakers U14 Boys Copper",
    oppTeam: "Vampire Wolves U14 Boys",
    teamScore: 14,
    oppScore: 34,
    halves: { h1:{team:8, opp:12}, h2:{team:6, opp:22} },
    players: [
      { name:"Archer Kenny", pts:2, ft:0, two:1, three:0, fouls:1 },
      { name:"Thomas O'Sullivan", pts:1, ft:1, two:0, three:0, fouls:1 },
      { name:"Jacob Nguyen", pts:0, ft:0, two:0, three:0, fouls:0 },
      { name:"Tate Power", pts:0, ft:0, two:0, three:0, fouls:2 },
      { name:"Ethan Poon", pts:6, ft:0, two:3, three:0, fouls:2 },
      { name:"Lior Rizvash", pts:0, ft:0, two:0, three:0, fouls:2 },
      { name:"Rodion Prystupa", pts:5, ft:1, two:2, three:0, fouls:3 }
    ],
    note: "Totals line shows 14 pts, 2 FT, 6 2PT, 0 3PT, 11 fouls."
  },
  {
    game: 6,
    opponent: "Lakers U14 Boys Flame",
    team: "Lakers U14 Boys Copper",
    oppTeam: "Lakers U14 Boys Flame",
    teamScore: 26,
    oppScore: 29,
    halves: { h1:{team:7, opp:15}, h2:{team:19, opp:14} },
    players: [
      { name:"Archer Kenny", pts:5, ft:1, two:2, three:0, fouls:0 },
      { name:"Bill Pham", pts:0, ft:0, two:0, three:0, fouls:0 },
      { name:"Thomas O'Sullivan", pts:2, ft:0, two:1, three:0, fouls:0 },
      { name:"Jacob Nguyen", pts:3, ft:1, two:1, three:0, fouls:1 },
      { name:"Tate Power", pts:0, ft:0, two:0, three:0, fouls:1 },
      { name:"Ethan Poon", pts:8, ft:0, two:4, three:0, fouls:0 },
      { name:"Lior Rizvash", pts:2, ft:0, two:1, three:0, fouls:4 },
      { name:"Rodion Prystupa", pts:6, ft:0, two:3, three:0, fouls:3 }
    ],
    note: "Totals line shows 26 pts, 2 FT, 12 2PT, 0 3PT, 10 fouls."
  },
  {
    game: 7,
    opponent: "Dark Wolves U14 Boys",
    team: "Lakers U14 Boys Copper",
    oppTeam: "Dark Wolves U14 Boys",
    teamScore: 26,
    oppScore: 28,
    halves: { h1:{team:10, opp:16}, h2:{team:16, opp:12} },
    players: [
      { name:"Archer Kenny", pts:0, ft:0, two:0, three:0, fouls:1 },
      { name:"Bill Pham", pts:4, ft:0, two:0, three:0, fouls:4 },
      { name:"Thomas O'Sullivan", pts:6, ft:0, two:0, three:0, fouls:1 },
      { name:"Jacob Nguyen", pts:4, ft:0, two:0, three:0, fouls:1 },
      { name:"Ethan Poon", pts:4, ft:0, two:0, three:0, fouls:0 },
      { name:"Lior Rizvash", pts:2, ft:0, two:0, three:0, fouls:4 },
      { name:"Rodion Prystupa", pts:6, ft:0, two:0, three:0, fouls:3 }
    ],
    note: "This game screenshot provided only PTS and Fouls per player (no FT/2PT/3PT splits)."
  },
  {
    game: 8,
    opponent: "Raptors U14 Boys Orange",
    team: "Lakers U14 Boys Copper",
    oppTeam: "Raptors U14 Boys Orange",
    teamScore: 28,
    oppScore: 45,
    halves: { h1:{team:16, opp:16}, h2:{team:12, opp:29} },
    players: [
      { name:"Archer Kenny", pts:6, ft:0, two:3, three:0, fouls:0 },
      { name:"Bill Pham", pts:2, ft:0, two:1, three:0, fouls:2 },
      { name:"Thomas O'Sullivan", pts:6, ft:2, two:2, three:0, fouls:3 },
      { name:"Jacob Nguyen", pts:0, ft:0, two:0, three:0, fouls:0 },
      { name:"Tate Power", pts:0, ft:0, two:0, three:0, fouls:1 },
      { name:"Ethan Poon", pts:10, ft:0, two:5, three:0, fouls:1 },
      { name:"Lior Rizvash", pts:0, ft:0, two:0, three:0, fouls:4 },
      { name:"Rodion Prystupa", pts:4, ft:0, two:2, three:0, fouls:0 }
    ],
    note: "Totals line shows 28 pts, 2 FT, 13 2PT, 0 3PT, 11 fouls."
  },
  {
    game: 9,
    opponent: "Carnegie Chargers U14 Boys Bears",
    team: "Lakers U14 Boys Copper",
    oppTeam: "Carnegie Chargers U14 Boys Bears",
    teamScore: 25,
    oppScore: 30,
    halves: { h1:{team:4, opp:13}, h2:{team:21, opp:17} },
    players: [
      { name:"Archer Kenny", pts:4, ft:0, two:2, three:0, fouls:0 },
      { name:"Thomas O'Sullivan", pts:11, ft:0, two:4, three:1, fouls:2 },
      { name:"Jacob Nguyen", pts:0, ft:0, two:0, three:0, fouls:0 },
      { name:"Tate Power", pts:0, ft:0, two:0, three:0, fouls:1 },
      { name:"Ethan Poon", pts:4, ft:2, two:1, three:0, fouls:2 },
      { name:"Lior Rizvash", pts:6, ft:0, two:3, three:0, fouls:3 },
      { name:"Rodion Prystupa", pts:0, ft:0, two:0, three:0, fouls:2 }
    ],
    note: "Totals line shows 25 pts, 2 FT, 10 2PT, 1 3PT, 10 fouls."
  }
];

const TARGET_GAMES = 10;

/* ============================================================
   2) STATE + HELPERS
   ============================================================ */

let GAMES = deepClone(INITIAL_GAMES);
let LAST_LOADED_FROM_FILE = false;

function deepClone(x){ return JSON.parse(JSON.stringify(x)); }
function safeNum(n){ return (Number.isFinite(+n) ? +n : 0); }
function round1(x){ x = safeNum(x); return Math.round(x*10)/10; }
function sum(arr, fn){ let t = 0; for(const a of arr){ t += safeNum(fn(a)); } return t; }
function uniq(arr){ return Array.from(new Set(arr)); }
function byNameAsc(a,b){ return a.name.localeCompare(b.name); }
function margin(g){ return safeNum(g.teamScore) - safeNum(g.oppScore); }
function isWin(g){ return margin(g) > 0; }

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ============================================================
   3) LOAD SEASON JSON (THIS IS THE KEY FIX)
   - Loads /data/season-2026.json
   - Merges minimal game fields into the richer schema
   - Uses cache busting for GitHub Pages
   ============================================================ */

async function loadSeasonFromFile(){
  try{
    const url = "./data/season-2026.json?v=" + Date.now(); // cache buster
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);

    const raw = await res.json();
    if(!Array.isArray(raw)) throw new Error("Root JSON must be an array");

    // Normalize into the dashboard schema
    const normalized = raw.map(g => ({
      game: safeNum(g.game),
      opponent: g.opponent || g.oppTeam || "Unknown",
      team: g.team || "Lakers U14 Boys Copper",
      oppTeam: g.oppTeam || g.opponent || "Opponent",
      teamScore: safeNum(g.teamScore),
      oppScore: safeNum(g.oppScore),
      halves: g.halves || { h1:{team:null,opp:null}, h2:{team:null,opp:null} },
      players: Array.isArray(g.players) ? g.players.map(p=>({
        name: p.name || "Unknown",
        pts: safeNum(p.pts),
        ft: safeNum(p.ft),
        two: safeNum(p.two),
        three: safeNum(p.three),
        fouls: safeNum(p.fouls),
      })) : [],
      note: g.note || ""
    })).filter(g => g.game !== 0);

    // De-dup by game number (latest wins)
    const map = new Map();
    for(const g of normalized){ map.set(g.game, g); }
    GAMES = Array.from(map.values()).sort((a,b)=>a.game-b.game);

    LAST_LOADED_FROM_FILE = true;
    render();
  }catch(err){
    console.warn("Could not load /data/season-2026.json. Using fallback INITIAL_GAMES.", err);
    LAST_LOADED_FROM_FILE = false;
    GAMES = deepClone(INITIAL_GAMES);
    render();
  }
}

/* ===================== */
/* END PART 2            */
/* ===================== */

<!-- ===================== -->
<!-- U14 SEASON DASHBOARD -->
<!-- PART 3 OF 3          -->
<!-- (final section)      -->
<!-- ===================== -->

/* ============================================================
   4) ANALYTICS BUILDERS
   ============================================================ */

function buildSnapshot(){
  const gp = GAMES.length;
  const wins = GAMES.filter(isWin).length;
  const pf = sum(GAMES, g=>g.teamScore);
  const pa = sum(GAMES, g=>g.oppScore);
  const avgPf = gp ? round1(pf/gp) : 0;
  const avgPa = gp ? round1(pa/gp) : 0;
  const avgMargin = gp ? round1((pf-pa)/gp) : 0;

  const tiles = document.getElementById("tiles");
  tiles.innerHTML = `
    <div class="tile">
      <div class="k">Record</div>
      <div class="v">${wins}-${gp-wins}</div>
      <div class="s">${gp} games</div>
    </div>
    <div class="tile">
      <div class="k">Avg Points For</div>
      <div class="v">${avgPf}</div>
      <div class="s">${pf} total</div>
    </div>
    <div class="tile">
      <div class="k">Avg Points Against</div>
      <div class="v">${avgPa}</div>
      <div class="s">${pa} total</div>
    </div>
    <div class="tile">
      <div class="k">Avg Margin</div>
      <div class="v">${avgMargin}</div>
      <div class="s">${avgMargin>0?"Positive":"Negative"}</div>
    </div>
  `;

  document.getElementById("loadedCount").textContent = gp;
  const dot = document.getElementById("loadedDot");
  dot.className = "dot " + (gp===TARGET_GAMES ? "good" : gp>=7 ? "warn" : "bad");
}

/* ============================================================
   5) RESULTS TABLE
   ============================================================ */

function buildResults(){
  const body = document.getElementById("resultsBody");
  body.innerHTML = "";

  for(const g of GAMES){
    const m = margin(g);
    const badge = m>0 ? "b-good" : m<0 ? "b-bad" : "b-mid";
    const label = m>0 ? "WIN" : m<0 ? "LOSS" : "DRAW";
    const halves =
      (g.halves?.h1?.team!=null)
        ? `${g.halves.h1.team}-${g.halves.h1.opp} / ${g.halves.h2.team}-${g.halves.h2.opp}`
        : "—";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono click">#${g.game}</td>
      <td>${escapeHtml(g.opponent)}</td>
      <td class="right mono">${g.teamScore}-${g.oppScore}</td>
      <td class="right mono">${m}</td>
      <td><span class="badge ${badge}">${label}</span></td>
      <td class="right mono muted">${halves}</td>
    `;
    tr.onclick = ()=> openGameModal(g);
    body.appendChild(tr);
  }
}

/* ============================================================
   6) PLAYER AGGREGATION
   ============================================================ */

function buildPlayers(){
  const map = new Map();

  for(const g of GAMES){
    for(const p of (g.players||[])){
      if(!map.has(p.name)){
        map.set(p.name, {
          name:p.name, games:0, pts:0, ft:0, two:0, three:0,
          fouls:0, highs:[], lows:[]
        });
      }
      const a = map.get(p.name);
      a.games++;
      a.pts += safeNum(p.pts);
      a.ft += safeNum(p.ft);
      a.two += safeNum(p.two);
      a.three += safeNum(p.three);
      a.fouls += safeNum(p.fouls);
      a.highs.push(p.pts);
      a.lows.push(p.pts);
    }
  }

  const totalTeamPts = sum(GAMES, g=>g.teamScore);
  const rows = Array.from(map.values())
    .sort((a,b)=>b.pts-a.pts);

  const body = document.getElementById("playersBody");
  body.innerHTML = "";

  for(const p of rows){
    const ppg = p.games ? round1(p.pts/p.games) : 0;
    const fpg = p.games ? round1(p.fouls/p.games) : 0;
    const hi = p.highs.length ? Math.max(...p.highs) : 0;
    const lo = p.lows.length ? Math.min(...p.lows) : 0;
    const share = totalTeamPts ? round1((p.pts/totalTeamPts)*100) : 0;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(p.name)}</td>
      <td class="right mono">${p.games}</td>
      <td class="right mono">${p.pts}</td>
      <td class="right mono">${ppg}</td>
      <td class="right mono">${p.ft}</td>
      <td class="right mono">${p.two}</td>
      <td class="right mono">${p.three}</td>
      <td class="right mono">${p.fouls}</td>
      <td class="right mono">${fpg}</td>
      <td class="right mono">${hi}</td>
      <td class="right mono">${lo}</td>
      <td class="right mono">${share}%</td>
    `;
    body.appendChild(tr);
  }
}

/* ============================================================
   7) CHARTS (CANVAS)
   ============================================================ */

function drawLineChart(canvasId, seriesA, seriesB){
  const c = document.getElementById(canvasId);
  const ctx = c.getContext("2d");
  const dpr = window.devicePixelRatio || 1;
  const w = c.clientWidth, h = c.clientHeight;
  c.width = w*dpr; c.height = h*dpr;
  ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,w,h);

  const pad = 26;
  const maxVal = Math.max(...seriesA, ...seriesB, 40);
  const stepX = (w-2*pad)/(seriesA.length-1 || 1);

  function plot(arr, color){
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.beginPath();
    arr.forEach((v,i)=>{
      const x = pad + i*stepX;
      const y = h-pad - (v/maxVal)*(h-2*pad);
      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    });
    ctx.stroke();
  }

  plot(seriesA, "#6ee7ff");
  plot(seriesB, "#ff5c7a");
}

function drawMarginChart(){
  const c = document.getElementById("chartMargins");
  const ctx = c.getContext("2d");
  const dpr = window.devicePixelRatio || 1;
  const w = c.clientWidth, h = c.clientHeight;
  c.width = w*dpr; c.height = h*dpr;
  ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,w,h);

  const pad = 26;
  const margins = GAMES.map(margin);
  const maxAbs = Math.max(...margins.map(m=>Math.abs(m)), 10);
  const barW = (w-2*pad)/margins.length - 6;

  margins.forEach((m,i)=>{
    const x = pad + i*((w-2*pad)/margins.length) + 3;
    const zeroY = h/2;
    const barH = (Math.abs(m)/maxAbs)*(h/2-pad);
    ctx.fillStyle = m>=0 ? "#2bd47d" : "#ff5c7a";
    ctx.fillRect(x, m>=0 ? zeroY-barH : zeroY, barW, barH);
  });

  ctx.strokeStyle = "rgba(255,255,255,.15)";
  ctx.beginPath();
  ctx.moveTo(pad, h/2);
  ctx.lineTo(w-pad, h/2);
  ctx.stroke();
}

/* ============================================================
   8) MODALS + EDITOR
   ============================================================ */

function openGameModal(g){
  document.getElementById("modalTitle").textContent =
    `Game ${g.game} vs ${g.opponent}`;
  document.getElementById("modalBody").innerHTML = `
    <p><strong>Score:</strong> ${g.teamScore}-${g.oppScore}</p>
    <p><strong>Halves:</strong>
      ${g.halves?.h1?.team!=null
        ? `${g.halves.h1.team}-${g.halves.h1.opp} / ${g.halves.h2.team}-${g.halves.h2.opp}`
        : "—"}
    </p>
    <pre class="mono">${escapeHtml(JSON.stringify(g.players,null,2))}</pre>
    <p class="small muted">${escapeHtml(g.note||"")}</p>
  `;
  document.getElementById("backdrop").style.display="flex";
}

document.getElementById("btnClose").onclick =
  ()=> document.getElementById("backdrop").style.display="none";

document.getElementById("btnOpenEditor").onclick = ()=>{
  document.getElementById("jsonEditor").value = JSON.stringify(GAMES,null,2);
  document.getElementById("editorBackdrop").style.display="flex";
};

document.getElementById("btnCancelEditor").onclick =
  ()=> document.getElementById("editorBackdrop").style.display="none";

document.getElementById("btnApply").onclick = ()=>{
  try{
    const data = JSON.parse(document.getElementById("jsonEditor").value);
    if(!Array.isArray(data)) throw new Error("Root must be array");
    GAMES = data;
    LAST_LOADED_FROM_FILE = false;
    document.getElementById("editorBackdrop").style.display="none";
    render();
  }catch(e){
    alert("Invalid JSON");
  }
};

document.getElementById("btnReset").onclick = loadSeasonFromFile;

/* ============================================================
   9) EXPORT
   ============================================================ */

document.getElementById("btnExport").onclick = ()=>{
  const rows = [["Game","Opponent","TeamScore","OppScore","Margin"]];
  GAMES.forEach(g=>rows.push([g.game,g.opponent,g.teamScore,g.oppScore,margin(g)]));
  const csv = rows.map(r=>r.join(",")).join("\n");
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download = "season-results.csv";
  a.click();
};

/* ============================================================
   10) RENDER + INIT
   ============================================================ */

function render(){
  buildSnapshot();
  buildResults();
  buildPlayers();

  drawLineChart(
    "chartForAgainst",
    GAMES.map(g=>g.teamScore),
    GAMES.map(g=>g.oppScore)
  );

  drawMarginChart();
}

window.addEventListener("resize", ()=> render());
loadSeasonFromFile();

/* ===================== */
/* END PART 3            */
/* ===================== */
</script>
</body>
</html>